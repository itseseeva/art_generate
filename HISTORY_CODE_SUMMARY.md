# КОД ДЛЯ СОХРАНЕНИЯ ИСТОРИИ СООБЩЕНИЙ И ФОТО

## Основные файлы:

### 1. `app/main.py` - Главная функция сохранения

**Функция `_write_chat_history` (строки 1038-1291)**
- Сохраняет историю чата в базу данных
- Сохраняет в ChatSession и ChatMessageDB
- Сохраняет в ChatHistory
- Обрабатывает фото (image_url и image_filename)

**Функция `process_chat_history_storage` (строки 1323-1358)**
- Обертка для _write_chat_history
- Вызывается из эндпоинта /chat

**Где вызывается:**
- Из `/chat` эндпоинта (строка 2136)
- Из `/api/v1/auth/user-gallery/add/` при добавлении фото в галерею (строка 1901 в app/auth/routers.py)

### 2. `app/tasks/chat_tasks.py` - Celery задача для асинхронного сохранения

**Функция `save_chat_history_async_task` (строки 30-94)**
- Асинхронная задача Celery
- Вызывает _write_chat_history в фоновом режиме

### 3. `app/auth/routers.py` - Сохранение при добавлении фото в галерею

**Эндпоинт `/auth/user-gallery/add/` (строки 1849-1950)**
- Добавляет фото в галерею пользователя
- После добавления вызывает process_chat_history_storage для сохранения в историю

### 4. `app/chat_history/services/chat_history_service.py` - Сервис для работы с историей

**Класс `ChatHistoryService`**
- Методы для сохранения и получения истории
- Проверка прав на сохранение истории

## Ключевые моменты:

1. **Сохранение фото:** image_url сохраняется в формате `[image:url]` в поле content, а также в отдельные поля image_url и image_filename

2. **Проверка подписки:** История сохраняется только для STANDARD и PREMIUM подписок

3. **Двойное сохранение:** История сохраняется в две таблицы:
   - ChatMessageDB (для контекста чата)
   - ChatHistory (для страницы истории)

4. **Сохранение при генерации фото:** Когда фото добавляется в галерею через `/auth/user-gallery/add/`, история автоматически сохраняется
