# Тесты Redis кэширования

## Запуск тестов

### Запуск всех тестов Redis:
```bash
pytest tests/redis/ -v
```

### Запуск всех тестов из папки tests:
```bash
# Все тесты проекта
pytest tests/ -v

# Или с указанием конкретного Python
python -m pytest tests/ -v
```

### Запуск конкретного файла тестов:
```bash
# Базовые функции кэширования
pytest tests/redis/test_redis_cache.py -v

# Кэширование подписок
pytest tests/redis/test_subscription_cache.py -v

# Кэширование персонажей
pytest tests/redis/test_characters_cache.py -v

# Кэширование пользователей
pytest tests/redis/test_user_cache.py -v

# Кэширование монет
pytest tests/redis/test_coins_cache.py -v

# Кэширование истории чата
pytest tests/redis/test_chat_history_cache.py -v
```

### Запуск с покрытием кода:
```bash
pytest tests/redis/ --cov=app.utils.redis_cache --cov=app.services --cov=app.chat_bot.api.character_endpoints --cov-report=html
```

### Запуск с подробным выводом:
```bash
pytest tests/redis/ -v -s
```

### Запуск конкретного теста:
```bash
pytest tests/redis/test_redis_cache.py::test_get_redis_client_success -v
```

## Структура тестов

### `test_redis_cache.py` - Базовые функции кэширования (13 тестов)

Тестирует основные операции работы с Redis:

- **`test_get_redis_client_success`** - Проверяет успешное подключение к Redis серверу
- **`test_get_redis_client_failure`** - Проверяет обработку ошибки при недоступном Redis
- **`test_cache_set_get`** - Тестирует сохранение и получение значений из кэша с TTL
- **`test_cache_get_none`** - Проверяет возврат `None` для несуществующих ключей
- **`test_cache_delete`** - Тестирует удаление ключа из кэша
- **`test_cache_delete_pattern`** - Проверяет удаление ключей по паттерну (например, `test:*`)
- **`test_cache_exists`** - Тестирует проверку существования ключа
- **`test_cache_exists_false`** - Проверяет возврат `False` для несуществующих ключей
- **`test_key_generators`** - Проверяет корректность генерации ключей кэша для всех типов данных
- **`test_cache_set_without_ttl`** - Тестирует сохранение без указания времени жизни
- **`test_cache_get_json_decode_error`** - Проверяет обработку ошибок декодирования JSON
- **`test_cache_set_dict_serialization`** - Тестирует сериализацию словарей при сохранении
- **`test_close_redis_client`** - Проверяет корректное закрытие соединения с Redis

### `test_subscription_cache.py` - Кэширование подписок (5 тестов)

Тестирует кэширование данных о подписках пользователей:

- **`test_get_user_subscription_from_cache`** - Проверяет получение подписки из кэша без обращения к БД
- **`test_get_user_subscription_from_db`** - Тестирует загрузку подписки из БД и автоматическое сохранение в кэш
- **`test_get_subscription_stats_from_cache`** - Проверяет получение статистики подписки (остатки кредитов, фото, дни до окончания) из кэша
- **`test_cache_invalidation_on_use_photo_generation`** - Тестирует инвалидацию кэша при использовании генерации фото (кэш должен очищаться)
- **`test_cache_invalidation_on_use_message_credits`** - Проверяет инвалидацию кэша при трате кредитов на сообщения

### `test_characters_cache.py` - Кэширование персонажей (3 теста)

Тестирует кэширование данных о персонажах:

- **`test_read_characters_from_cache`** - Проверяет получение списка персонажей из кэша без запроса к БД
- **`test_read_characters_from_db`** - Тестирует загрузку списка персонажей из БД и сохранение в кэш
- **`test_read_character_from_cache`** - Проверяет получение данных конкретного персонажа из кэша

### `test_user_cache.py` - Кэширование пользователей (2 теста)

Тестирует кэширование данных пользователей при аутентификации:

- **`test_get_current_user_from_cache`** - Проверяет получение пользователя из кэша по JWT токену без обращения к БД
- **`test_get_current_user_from_db`** - Тестирует загрузку пользователя из БД и сохранение в кэш при отсутствии в кэше

### `test_coins_cache.py` - Кэширование монет (4 теста)

Тестирует кэширование баланса монет пользователей:

- **`test_get_user_coins_from_cache`** - Проверяет получение баланса монет из кэша
- **`test_get_user_coins_from_db`** - Тестирует загрузку баланса из БД и сохранение в кэш
- **`test_cache_invalidation_on_spend_coins`** - Проверяет инвалидацию кэша при трате монет
- **`test_cache_invalidation_on_add_coins`** - Тестирует инвалидацию кэша при пополнении баланса

### `test_chat_history_cache.py` - Кэширование истории чата (3 теста)

Тестирует кэширование истории сообщений чата:

- **`test_get_chat_history_from_cache`** - Проверяет получение истории чата из кэша для конкретного персонажа и сессии
- **`test_get_chat_history_from_db`** - Тестирует загрузку истории из БД и сохранение в кэш
- **`test_cache_invalidation_on_save_message`** - Проверяет инвалидацию кэша при сохранении нового сообщения в историю

## Что проверяют тесты

Все тесты используют **реальный Redis сервер** (не моки) и проверяют:

1. **Корректность работы кэша** - данные правильно сохраняются и извлекаются
2. **Стратегию "Cache-Aside"** - при отсутствии в кэше данные загружаются из БД и сохраняются в кэш
3. **Инвалидацию кэша** - при изменении данных (трата монет, использование кредитов, сохранение сообщений) кэш автоматически очищается
4. **Изоляцию тестов** - каждый тест работает с чистой базой Redis (база очищается до и после теста)
5. **Обработку ошибок** - корректная работа при недоступном Redis или ошибках подключения

## Примечания

- Все тесты используют **реальный Redis сервер** (не моки). Перед запуском убедитесь, что Redis запущен:
  ```bash
  docker compose up redis -d
  ```
- Для тестов используется отдельная база Redis: `TEST_REDIS_URL=redis://localhost:6379/15` (устанавливается автоматически в `conftest.py`, но можно переопределить через переменную окружения).
- При отсутствии соединения с Redis тесты будут автоматически помечены как `skipped` с понятным сообщением.
- Каждый тест работает с изолированной базой - перед и после теста база очищается (`flushdb()`), что гарантирует отсутствие побочных эффектов между тестами.

## Устранение проблем

### Ошибка импорта модулей:
```bash
# Убедитесь, что вы в корневой директории проекта
cd C:/project_A
pytest tests/redis/ -v
```

### Ошибка pytest-asyncio:
```bash
pip install pytest-asyncio
```

### Ошибка с моками:
Убедитесь, что установлены все зависимости:
```bash
pip install -r requirements.txt
```

