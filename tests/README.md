# üìã –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
```bash
pytest
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
```bash
# –¢–µ—Å—Ç—ã —á–∞—Ç–∞
pytest tests/routers/test_chat_endpoints.py -v

# –¢–µ—Å—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫
pytest tests/test_subscriptions.py -v

# –¢–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
pytest tests/test_image_generation.py -v
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
```bash
pytest --cov=app --cov-report=html
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ chat_bot/
‚îÇ   ‚îî‚îÄ‚îÄ test_character_endpoints.py    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
‚îú‚îÄ‚îÄ chat_history/
‚îÇ   ‚îî‚îÄ‚îÄ test_chat_history_service.py   # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îú‚îÄ‚îÄ test_chat_endpoints.py         # –ß–∞—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ test_gallery.py                # –ì–∞–ª–µ—Ä–µ—è
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ test_profit_activate_service.py # –°–µ—Ä–≤–∏—Å –ø–æ–¥–ø–∏—Å–æ–∫
‚îú‚îÄ‚îÄ test_celery.py                     # Celery –∑–∞–¥–∞—á–∏
‚îú‚îÄ‚îÄ test_config.py                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test_image_generation.py           # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îú‚îÄ‚îÄ test_redis.py                      # Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ test_subscriptions.py              # –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫
```

---

## üß™ –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

### üí¨ –ß–∞—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏—è

#### `tests/routers/test_chat_endpoints.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏.

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_get_chat_status_online` | ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OpenRouter API |
| `test_chat_with_character_success` | ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂—É |
| `test_chat_stream_success` | ‚úÖ –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ç–≤–µ—Ç–æ–≤ (SSE) |
| `test_generate_voice_no_subscription` | ‚ùå –û—Ç–∫–∞–∑ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏ |

**–ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
- –û–±—ã—á–Ω—ã–π —á–∞—Ç (POST `/api/v1/chat/chat`)
- –°—Ç—Ä–∏–º–∏–Ω–≥ —á–∞—Ç (POST `/api/v1/chat/chat/stream`)
- TTS –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

#### `tests/chat_history/test_chat_history_service.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä–≤–∏—Å –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤.

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_can_save_history_active_subscription` | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ |
| `test_can_save_history_no_subscription` | ‚ùå –ó–∞–ø—Ä–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (None) |
| `test_save_message_success` | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î –∏ –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ |
| `test_get_chat_history_from_cache` | ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ –∫–µ—à–∞ |
| `test_get_chat_history_db_fallback` | ‚úÖ Fallback –Ω–∞ –ë–î –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ –∫–µ—à–∞ |
| `test_clear_all_chat_history_success` | ‚úÖ –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ |
| `test_get_history_stats_success` | ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º |
| `test_get_user_characters_with_history_*` | ‚úÖ –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å –∏—Å—Ç–æ—Ä–∏–µ–π |

> [!IMPORTANT]
> **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –í–°–ï–• —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫** (FREE, STANDARD, PREMIUM).
> –¢–µ—Å—Ç `test_can_save_history_no_subscription` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (None), –∞ –Ω–µ FREE –ø–æ–¥–ø–∏—Å–∫—É.

---

### üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏

#### `tests/chat_bot/test_character_endpoints.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏.

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_get_available_voices_*` | ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤ (—Å/–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) |
| `test_get_character_not_found` | ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `test_create_character_success` | ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `test_get_character_details` | ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `test_update_character` | ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º |
| `test_delete_character` | ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º |

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- `GET /api/v1/characters/available-voices`
- `GET /api/v1/characters/{id}`
- `POST /api/v1/characters/create/`
- `PUT /api/v1/characters/{id}/user-edit`
- `DELETE /api/v1/characters/{id}`

---

### üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è

#### `tests/routers/test_gallery.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç–Ω—É—é –≥–∞–ª–µ—Ä–µ—é –∏ —Å–∏—Å—Ç–µ–º—É —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–ª—å–±–æ–º–æ–≤.

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_list_unlocked_albums_success` | ‚úÖ –°–ø–∏—Å–æ–∫ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤ |
| `test_get_paid_album_status_unlocked_by_subscription` | ‚úÖ –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ STANDARD –ø–æ–¥–ø–∏—Å–∫—É |
| `test_unlock_paid_gallery_forbidden_for_free` | ‚ùå –ó–∞–ø—Ä–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è FREE |
| `test_unlock_paid_gallery_success_standard` | ‚úÖ –£—Å–ø–µ—à–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è STANDARD |
| `test_list_paid_gallery_access_denied_for_free` | ‚ùå –ó–∞–ø—Ä–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è FREE |
| `test_save_paid_gallery_photos_forbidden_for_non_owner` | ‚ùå –ó–∞–ø—Ä–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ-–≤–ª–∞–¥–µ–ª—å—Ü–µ–º |

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥–∞–ª–µ—Ä–µ—é
- STANDARD/PREMIUM –∏–º–µ—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø
- –í–ª–∞–¥–µ–ª–µ—Ü –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–æ—Ç–æ

---

### üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

#### `tests/test_image_generation.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å RunPod API –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

**Unit —Ç–µ—Å—Ç—ã:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_clean_prompt` | ‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ |
| `test_clean_prompt_unicode` | ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö Unicode —Å–∏–º–≤–æ–ª–æ–≤ |

**Integration —Ç–µ—Å—Ç—ã (—Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ RunPod):**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç | –í—Ä–µ–º—è |
|------|---------------|-------|
| `test_runpod_model_1_availability` | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Model 1 (anime) | ~5 —Å–µ–∫ |
| `test_runpod_model_2_availability` | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Model 2 (anime-realism) | ~5 —Å–µ–∫ |
| `test_successful_image_generation` | ‚úÖ –ü–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è | 20-60 —Å–µ–∫ |

**Mock —Ç–µ—Å—Ç—ã:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_start_generation_success` | ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| `test_generation_timeout` | ‚è±Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ |
| `test_generation_failed_status` | ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ FAILED |
| `test_generation_cancelled` | üö´ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| `test_generation_completed_with_url` | ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| `test_missing_api_key` | ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ API –∫–ª—é—á–∞ |
| `test_retry_on_network_error` | üîÑ Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö |

---

### üí≥ –ü–æ–¥–ø–∏—Å–∫–∏

#### `tests/test_subscriptions.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–ø–∏—Å–æ–∫, –ª–∏–º–∏—Ç—ã –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏.

**–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_purchase_standard_subscription` | ‚úÖ –ü–æ–∫—É–ø–∫–∞ STANDARD (30 –¥–Ω–µ–π) |
| `test_purchase_premium_subscription` | ‚úÖ –ü–æ–∫—É–ø–∫–∞ PREMIUM (30 –¥–Ω–µ–π) |

**–ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –ø–æ —Ç–∏–ø–∞–º:**
| –¢–µ—Å—Ç | FREE | STANDARD | PREMIUM |
|------|------|----------|---------|
| –°–æ–æ–±—â–µ–Ω–∏—è | 10/–º–µ—Å—è—Ü | ‚àû | ‚àû |
| –ö—Ä–µ–¥–∏—Ç—ã | 100 | 1000 | 5000 |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ | 10 | 100 | 500 |
| –ì–æ–ª–æ—Å (—Å–∏–º–≤–æ–ª—ã) | 0 | 50000 | 200000 |

**–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_subscription_limits_accumulation` | ‚úÖ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–∫—É–ø–∫–µ |
| `test_subscription_expiration` | ‚è∞ –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π |
| `test_monthly_limits_reset` | üîÑ –†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ (–º–µ—Ç–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞) |
| `test_use_photo_generation` | ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ |
| `test_use_voice` | ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –≥–æ–ª–æ—Å–∞ |

> [!IMPORTANT]
> **–õ–∏–º–∏—Ç—ã –ù–ï —Å–≥–æ—Ä–∞—é—Ç –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏!**
> –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Å—Ç–∞—Ç–∫–∏ –ª–∏–º–∏—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏.
> –ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Å—Ç–∞–ª–æ—Å—å 30 —Ñ–æ—Ç–æ + –∫—É–ø–∏–ª–∏ –µ—â–µ 50 = –∏—Ç–æ–≥–æ 80 —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ.

#### `tests/services/test_profit_activate_service.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_get_user_subscription_cache_hit` | ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –∫–µ—à–∞ |
| `test_get_user_subscription_db_success` | ‚úÖ Fallback –Ω–∞ –ë–î |
| `test_use_credits_amount_success` | ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ |
| `test_activate_subscription_new_standard` | ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ |
| `test_activate_subscription_renewal_with_bonus` | üéÅ –ë–æ–Ω—É—Å –∑–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤ |
| `test_add_credits_topup_success` | ‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ |
| `test_can_user_send_message_success` | ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `test_use_message_credits_success` | ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| `test_use_photo_generation_success` | ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–æ—Ç–æ |

---

### üóÑÔ∏è Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

#### `tests/test_redis.py`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Redis –∫–µ—à –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

**–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_redis_connection` | ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis |
| `test_redis_set_get` | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ |
| `test_redis_set_get_json` | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ JSON |
| `test_redis_ttl` | ‚è±Ô∏è –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–µ–π (TTL) |
| `test_redis_delete` | ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π |

**–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_redis_pipeline` | ‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| `test_cache_invalidation` | ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –∫–ª—é—á—É |
| `test_cache_invalidation_pattern` | ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É |
| `test_redis_concurrent_access` | üîÄ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø |

**–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `test_character_cache_hit` | ‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –∫–µ—à –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π |
| `test_character_cache_miss` | ‚ùå –ü—Ä–æ–º–∞—Ö –∫–µ—à–∞ |
| `test_cache_performance` | ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–µ—à–∞ |

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### `tests/test_config.py`
–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –æ—Ç production –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**–ß—Ç–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è:**
- üóÑÔ∏è `DATABASE_URL` ‚Üí —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î `art_generate_test_db`
- üî¥ `REDIS_URL` ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- üîë API –∫–ª—é—á–∏ ‚Üí —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- üìß Email ‚Üí –æ—Ç–∫–ª—é—á–µ–Ω
- ‚òÅÔ∏è Yandex Storage ‚Üí –º–æ–∫
- üì± Telegram Bot ‚Üí –æ—Ç–∫–ª—é—á–µ–Ω

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: **17%**

**–•–æ—Ä–æ—à–æ –ø–æ–∫—Ä—ã—Ç–æ (>50%):**
- ‚úÖ –ú–æ–¥–µ–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫ (`app/models/subscription.py`) - 51%
- ‚úÖ –°—Ö–µ–º—ã —á–∞—Ç–∞ (`app/chat_bot/schemas/chat.py`) - 94%
- ‚úÖ –ú–æ–¥–µ–ª–∏ —á–∞—Ç-–±–æ—Ç–∞ (`app/chat_bot/models/models.py`) - 85%
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Ç–∞ (`app/chat_bot/config/chat_config.py`) - 75%

**–¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è (<30%):**
- ‚ö†Ô∏è –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (`app/chat_bot/api/character_endpoints.py`) - 6%
- ‚ö†Ô∏è –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä (`app/main.py`) - 12%
- ‚ö†Ô∏è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`app/auth/routers.py`) - 11%
- ‚ö†Ô∏è –°–µ—Ä–≤–∏—Å—ã (`app/services/*`) - 7-33%

---

## üéØ –ß—Ç–æ –ù–ï –ø–æ–∫—Ä—ã—Ç–æ —Ç–µ—Å—Ç–∞–º–∏

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤:
1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ OAuth**
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google/–Ø–Ω–¥–µ–∫—Å
   - JWT —Ç–æ–∫–µ–Ω—ã
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è

2. **–ü–ª–∞—Ç–µ–∂–∏**
   - –ÆKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –ÆMoney –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤

3. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º
   - –®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º

4. **Celery –∑–∞–¥–∞—á–∏**
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
   - –§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
   - –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞

5. **Admin –ø–∞–Ω–µ–ª—å**
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
pytest

# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
pytest --cov=app --cov-report=html

# –¢–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (–±–µ–∑ integration)
pytest -m "not integration"

# –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
pytest tests/test_subscriptions.py -v
```

### CI/CD
–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

---

## üìù –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç

### 1. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
```
tests/
‚îú‚îÄ‚îÄ routers/          # –î–ª—è API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ services/         # –î–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
‚îú‚îÄ‚îÄ chat_bot/         # –î–ª—è —Ñ—É–Ω–∫—Ü–∏–π —á–∞—Ç-–±–æ—Ç–∞
‚îî‚îÄ‚îÄ test_*.py         # –î–ª—è –æ–±—â–∏—Ö —É—Ç–∏–ª–∏—Ç
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
```python
@pytest.mark.asyncio
async def test_my_feature(
    client: AsyncClient,           # HTTP –∫–ª–∏–µ–Ω—Ç
    test_user_free: Users,          # FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    auth_headers_free: dict,        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    db_session: AsyncSession        # –ë–î —Å–µ—Å—Å–∏—è
):
    # –í–∞—à —Ç–µ—Å—Ç
    pass
```

### 3. –°–ª–µ–¥—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É AAA
```python
async def test_example():
    # Arrange (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)
    user = create_test_user()
    
    # Act (–¥–µ–π—Å—Ç–≤–∏–µ)
    response = await client.post("/api/endpoint", json={...})
    
    # Assert (–ø—Ä–æ–≤–µ—Ä–∫–∞)
    assert response.status_code == 200
    assert response.json()["status"] == "success"
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```bash
pytest tests/test_subscriptions.py::test_purchase_standard_subscription -v
```

### –ü–æ–∫–∞–∑–∞—Ç—å print() –≤ —Ç–µ—Å—Ç–∞—Ö
```bash
pytest -s
```

### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
```bash
pytest -x
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã
```bash
pytest --lf
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Pytest –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.pytest.org/)
- [AsyncIO —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](https://pytest-asyncio.readthedocs.io/)
- [Coverage.py](https://coverage.readthedocs.io/)
- [Faker –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö](https://faker.readthedocs.io/)

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`pytest`)
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ –Ω–µ —É–ø–∞–ª–æ (`pytest --cov`)
- [ ] –ù–æ–≤—ã–π –∫–æ–¥ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
- [ ] –¢–µ—Å—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã (docstrings)
- [ ] –ù–µ—Ç skip/xfail –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã
