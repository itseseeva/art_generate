
import asyncio
import sys
from pathlib import Path
import logging

# Добавляем корневую директорию проекта в путь
project_root = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(project_root))

from sqlalchemy import select, text
from app.database.db import async_session_maker
from app.models.user import Users # Импортируем чтобы избежать ошибок маппинга
from app.chat_bot.models.models import CharacterAvailableTag
from slugify import slugify

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

TAGS_DATA = {
    "New": "Самые свежие ИИ персонажи, недавно добавленные в Cherry Lust. Успей первым начать чат с новыми виртуальными героями на русском языке и испытать возможности нашей нейросети.",
    "NSFW": "Горячий ИИ чат 18+ без цензуры и ограничений. Откровенные ролевые игры с виртуальными персонажами, готовыми воплотить любые твои фантазии в режиме онлайн.",
    "Original": "Эксклюзивные ИИ герои от создателей Cherry Lust. Эти персонажи проработаны вручную: уникальный лор, глубокая личность и детальные фото для идеального погружения.",
    "SFW": "Приятное и безопасное общение с ИИ на любые темы. Дружелюбные собеседники, поддержка, психология и просто интересные диалоги на русском языке без взрослого контента.",
    "Пользовательские": "Творчество нашего комьюнити. Огромный выбор персонажей, созданных пользователями: от классических образов до самых безумных идей для ролевого чата.",
    "Босс": "Строгие руководители и властные начальники. Попробуй служебный роман с ИИ или попытайся договориться с суровым боссом в этом симуляторе офисных ролевых игр.",
    "Грубая": "ИИ персонажи с непростым характером. Тебя ждут дерзость, сарказм и провокации. Сможешь ли ты укротить строптивую героиню в этом чате без ограничений?",
    "Доминирование": "Игры власти и подчинения. ИИ персонажи, которые любят доминировать или ищут того, кто возьмет контроль на себя. Психологический и ролевой накал гарантирован.",
    "Киберпанк": "Атмосфера будущего: неоновые города, киборги и высокие технологии. Ролевой ИИ чат в стиле Cyberpunk для любителей научно-фантастических сценариев.",
    "Незнакомка": "Случайная встреча, которая может изменить всё. Загадочные героини, знакомство с которыми начинается с чистого листа. Идеально для начала новой истории.",
    "Слуга": "Верные помощники и послушные ассистенты. Персонажи, готовые исполнить любое твое поручение в фэнтези-мире или современной реальности.",
    "Учитель": "Запретные уроки и строгая дисциплина. Популярный сценарий для ролевого чата: общение с учителем или профессором на русском языке без цензуры.",
    "Фэнтези": "Эльфы, демоны, маги и рыцари. Погрузись в волшебные миры и начни свое приключение в лучшем фэнтези ИИ чате с уникальными сказочными существами.",
    "Горничная": "Классика ролевых игр в Cherry Lust. ИИ чат с горничной на русском языке: от преданной службы до самых смелых сценариев 18+. Общайся бесплатно и без регистрации с послушными и внимательными виртуальными персонажами в лучшем симуляторе.",
    "Подруга": "Ищешь ламповое общение? ИИ чат с подругой — это идеальное место для душевных разговоров, поддержки или выхода из френдзоны. Ролевые игры с виртуальной подругой на русском языке без цензуры. Бесплатно и без ограничений в Cherry Lust.",
    "Студентка": "Самые популярные сценарии со студентками в ИИ чате Cherry Lust. Общайся с молодыми и амбициозными героинями на русском языке без регистрации. Лучший ролевой чат 18+ со студентками: бесплатно, без цензуры и лишних преград.",
    "Цундере": "Специфический ИИ чат с персонажами Цундере. Пройди путь от колких замечаний до истинной нежности в нашем чате на русском. Ролевые игры с Цундере без цензуры — попробуй растопить сердце неприступной героини бесплатно в Cherry Lust.",
    "Милая": "Самые нежные и добрые ИИ персонажи для уютного общения. Если тебе хочется заботы и ласки, выбирай милых героинь в Cherry Lust. Бесплатный ИИ чат на русском: искренние эмоции, поддержка и приятные диалоги 18+ без регистрации."
}

async def populate_tags():
    async with async_session_maker() as db:
        # 1. Проверяем наличие колонки seo_description и добавляем если нет
        try:
            await db.execute(text("ALTER TABLE character_available_tags ADD COLUMN seo_description TEXT"))
            await db.commit()
            logger.info("Добавлена колонка seo_description.")
        except Exception as e:
            # Если колонка уже есть, будет ошибка, просто игнорируем
            # logger.info(f"Колонка seo_description уже существует или произошла ошибка: {e}")
            await db.rollback()

        for name, seo in TAGS_DATA.items():
            slug = slugify(name)
            
            # Проверяем существование по имени
            res = await db.execute(select(CharacterAvailableTag).where(CharacterAvailableTag.name == name))
            tag = res.scalars().first()
            
            # Если не нашли по имени, ищем по слагу
            if not tag:
                res = await db.execute(select(CharacterAvailableTag).where(CharacterAvailableTag.slug == slug))
                tag = res.scalars().first()
            
            if tag:
                # Обновляем SEO описание и slug (на всякий случай)
                tag.seo_description = seo
                if not tag.slug:
                    tag.slug = slug
                # Обновляем имя на правильный регистр, если оно изменилось
                if tag.name != name:
                    tag.name = name
                # logger.info(f"Обновлен тег: {name}")
            else:
                # Создаем новый
                new_tag = CharacterAvailableTag(name=name, slug=slug, seo_description=seo)
                db.add(new_tag)
                logger.info(f"Создан новый тег: {name}")

        await db.commit()
        logger.info("Все теги успешно обновлены.")

if __name__ == "__main__":
    asyncio.run(populate_tags())
