# Тестирование платежей YooKassa

## Обзор

YooKassa предоставляет тестовую среду для проверки интеграции без реальных денег. Все платежи в тестовом режиме являются виртуальными и не списывают средства с карт.

## Настройка тестового режима

### 1. Получение тестовых ключей

1. Зайдите в [личный кабинет YooKassa](https://yookassa.ru/my)
2. Перейдите в раздел **"Настройки" → "API"**
3. Включите **"Тестовый режим"**
4. Скопируйте **Тестовый shop_id** и **Тестовый секретный ключ**

### 2. Настройка переменных окружения

В файле `.env` или `env` установите тестовые ключи:

```env
# Тестовые ключи YooKassa
YOOKASSA_SHOP_ID=ваш_тестовый_shop_id
# Поддерживается несколько вариантов названий:
YOU_KASSA_TEST_API_KEY=ваш_тестовый_секретный_ключ
# или
YOU_KASSA_API_KEY=ваш_тестовый_секретный_ключ
# или
YOOKASSA_SECRET_KEY=ваш_тестовый_секретный_ключ

# URL для возврата после оплаты (можно использовать локальный)
YOOKASSA_RETURN_URL=http://localhost:3000/shop
```

**ВАЖНО**: Используйте **тестовые ключи**, а не боевые! Тестовые ключи начинаются с `test_` или имеют специальный формат.

### 3. Настройка webhook для локального тестирования

YooKassa отправляет webhook на ваш сервер, но для локального тестирования нужен публичный URL. Используйте один из вариантов:

#### Вариант 1: ngrok (рекомендуется)

1. Установите [ngrok](https://ngrok.com/download)
2. Запустите ваш FastAPI сервер на порту 8000:
   ```bash
   uvicorn app.main:app --reload --port 8000
   ```
3. В отдельном терминале запустите ngrok:
   ```bash
   ngrok http 8000
   ```
4. Скопируйте HTTPS URL (например, `https://abc123.ngrok.io`)
5. В настройках YooKassa укажите webhook URL:
   ```
   https://abc123.ngrok.io/api/v1/kassa/webhook/
   ```

#### Вариант 2: localtunnel

1. Установите localtunnel:
   ```bash
   npm install -g localtunnel
   ```
2. Запустите туннель:
   ```bash
   lt --port 8000
   ```
3. Скопируйте полученный URL и используйте его в настройках YooKassa

#### Настройка событий webhook в YooKassa

В настройках HTTP-уведомлений в личном кабинете YooKassa:

1. **URL для уведомлений**: `https://ваш-ngrok-url.ngrok.io/api/v1/kassa/webhook/`
2. **События для уведомлений** (важно выбрать правильные!):
   - ✅ `payment.succeeded` - "Платеж прошел успешно" (ОБЯЗАТЕЛЬНО!)
   - ❌ НЕ включайте `payout.succeeded` - это для выплат, а не платежей

**ВАЖНО**: Событие должно быть именно `payment.succeeded`, а не `payout.succeeded`!

После настройки webhook будет автоматически зачислять кредиты/подписки при успешной оплате.

## Тестовые карты для оплаты

YooKassa предоставляет специальные тестовые карты для проверки различных сценариев:

### Успешная оплата

```
Номер карты: 5555 5555 5555 4444
Срок действия: любая дата в будущем (например, 12/25)
CVC: любые 3 цифры (например, 123)
Имя держателя: любое имя
```

Эта карта всегда успешно проходит оплату.

### Отклоненная оплата

```
Номер карты: 5555 5555 5555 4477
Срок действия: любая дата в будущем
CVC: любые 3 цифры
```

Эта карта всегда отклоняется банком.

### 3D Secure (дополнительная аутентификация)

```
Номер карты: 5555 5555 5555 4477
Срок действия: любая дата в будущем
CVC: любые 3 цифры
```

При оплате этой картой потребуется подтверждение через 3D Secure.

## Проверка работы платежей

### 1. Создание тестового платежа

Используйте API для создания платежа:

```bash
POST /api/v1/kassa/create_payment/
Authorization: Bearer <ваш_токен>

{
  "amount": 149.0,
  "description": "Тестовая покупка Small пакета",
  "payment_type": "topup",
  "package_id": "small",
  "payment_method": "bank_card"
}
```

### 2. Оплата тестовой картой

1. После создания платежа вы получите `confirmation_url`
2. Перейдите по этой ссылке
3. Введите данные тестовой карты: `5555 5555 5555 4444`
4. Завершите оплату

### 3. Проверка webhook

После успешной оплаты YooKassa отправит webhook на ваш эндпоинт:

```
POST /api/v1/kassa/webhook/
```

Webhook содержит информацию о платеже и автоматически:
- Зачисляет кредиты пользователю (для `topup`)
- Активирует подписку (для `subscription`)

### 4. Проверка транзакций

Проверьте, что транзакция создана и обработана:

```bash
GET /api/v1/kassa/transactions/{user_id}
Authorization: Bearer <ваш_токен>
```

Ответ должен содержать транзакцию со статусом `processed: true`.

## Проверка зачисления кредитов/подписки

### Проверка кредитов

После успешной оплаты пакета кредитов (`topup`):

1. Проверьте баланс пользователя через API профиля
2. Убедитесь, что кредиты добавлены к текущему балансу
3. Проверьте транзакцию в БД - она должна быть `processed: true`

### Проверка подписки

После успешной оплаты подписки (`subscription`):

1. Проверьте `subscription_type` пользователя
2. Проверьте `subscription_end_date` - должна быть установлена дата окончания
3. Проверьте, что кредиты добавлены к балансу
4. Проверьте транзакцию в БД

## Ручная обработка транзакции

Если webhook не пришел (например, при локальной разработке), можно обработать транзакцию вручную:

```bash
POST /api/v1/kassa/process-transaction/{operation_id}
Authorization: Bearer <токен_администратора>
```

**Требуется**: права администратора (`is_admin: true`)

## Тестирование различных методов оплаты

### Банковские карты
```json
{
  "payment_method": "bank_card"
}
```
Используйте тестовую карту `5555 5555 5555 4444`

### СБП (Система быстрых платежей)
```json
{
  "payment_method": "sbp"
}
```
В тестовом режиме СБП работает как обычная оплата

### SberPay
```json
{
  "payment_method": "sberbank"
}
```

### ЮMoney
```json
{
  "payment_method": "yoo_money"
}
```

## Логирование

Все операции логируются с префиксом `[YOOKASSA]`:

- `[YOOKASSA] Creating payment` - создание платежа
- `[YOOKASSA WEBHOOK]` - обработка webhook
- `[YOOKASSA] Transaction created` - создание транзакции

Проверяйте логи для отладки:

```bash
# В логах приложения ищите записи с [YOOKASSA]
```

## Частые проблемы

### Webhook не приходит

1. **Локальная разработка**: Используйте [ngrok](https://ngrok.com/) или [localtunnel](https://localtunnel.github.io/www/) для проброса webhook
2. **Проверьте URL webhook** в настройках YooKassa
3. **Используйте ручную обработку** транзакции через `/process-transaction/`

### Транзакция не обрабатывается

1. Проверьте логи на наличие ошибок
2. Убедитесь, что `package_id` или `plan` указаны корректно
3. Проверьте, что пользователь существует в БД
4. Используйте ручную обработку через `/process-transaction/`

### Неверная сумма после комиссии

Система проверяет минимальную сумму с учетом комиссии YooKassa:
- СБП: 0.4%
- Банковские карты: 3.5%
- SberPay: 3.5%
- ЮMoney: 3.5%

Если сумма слишком мала после вычета комиссии, платеж будет отклонен.

## Переход на боевой режим

Когда все протестировано:

1. Отключите тестовый режим в личном кабинете YooKassa
2. Получите боевые ключи
3. Обновите переменные окружения на боевые ключи
4. Убедитесь, что `YOOKASSA_RETURN_URL` указывает на боевой домен
5. Настройте webhook URL на боевой сервер

## Дополнительные ресурсы

- [Документация YooKassa](https://yookassa.ru/developers)
- [Тестирование платежей](https://yookassa.ru/developers/using-api/testing)
- [Тестовые карты](https://yookassa.ru/developers/using-api/testing#test-cards)
