# Development commands
./webui-forge-sdxl.bat
cd frontend && npm run dev -- --port 5175

# Запуск backend (с автоматической очисткой порта 8000)
# Очистка порта от старых Python процессов (uvicorn), НЕ трогая Docker:
powershell -Command "$connections = Get-NetTCPConnection -LocalPort 8000 -ErrorAction SilentlyContinue; $connections | ForEach-Object { $proc = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue; if ($proc) { $procName = $proc.ProcessName.ToLower(); $procPath = $proc.Path -replace '\\', '/' -replace '//', '/'; if (($procName -eq 'python' -or $procName -eq 'pythonw') -and $procPath -notlike '*docker*' -and $procPath -notlike '*wsl*') { try { $cmdLine = (Get-CimInstance Win32_Process -Filter \"ProcessId = $($proc.Id)\" -ErrorAction SilentlyContinue).CommandLine; if ($cmdLine -like '*uvicorn*' -or $cmdLine -like '*app.main*' -or $cmdLine -like '*fastapi*') { Write-Host \"Останавливаем: $procName (PID: $($proc.Id))\"; Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue } } catch { } } } }" && sleep 1 && uvicorn app.main:app --host 0.0.0.0 --port 8000 --no-access-log

# Запуск без очистки порта (если порт свободен):
uvicorn app.main:app --host 0.0.0.0 --port 8000 --no-access-log

# Запуск с автоперезагрузкой (без очистки порта):
uvicorn app.main:app --host 0.0.0.0 --port 8001 --no-access-log


# Production запуск:
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker


# ============================================================================
# ТЕСТИРОВАНИЕ
# ============================================================================

# Активировать venv (обязательно перед запуском тестов!)
venv\Scripts\activate

# Запустить ВСЕ тесты разом
pytest

# Запустить ВСЕ тесты с подробным выводом
pytest -v

# Запустить только UNIT тесты (быстро, без внешних API)
pytest -m "unit" -v

# Запустить только INTEGRATION тесты
pytest -m "integration" -v

# Запустить тесты с покрытием кода (coverage)
pytest --cov=app --cov-report=html

# Запустить тесты параллельно (быстрее)
pytest -n auto

# Пропустить медленные тесты
pytest -m "not slow"

# Пропустить тесты RunPod (требуют API ключ)
pytest -m "not runpod"

# Запустить конкретный файл тестов
pytest tests/test_subscriptions.py -v

# Запустить конкретный тест
pytest tests/test_subscriptions.py::test_premium_subscription_privileges -vv

# Остановиться на первой ошибке
pytest -x

# Показать локальные переменные при ошибке
pytest -l

# Запустить последние упавшие тесты
pytest --lf

# Полный прогон для CI/CD (с покрытием и строгими требованиями)
pytest --cov=app --cov-report=term-missing --cov-fail-under=70 -v

