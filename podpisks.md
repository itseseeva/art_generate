# Документация: Система подписок и кредитов

## Обзор

Система подписок и кредитов обеспечивает монетизацию платформы через подписки и разовые покупки кредитов. Реализована интеграция с платежной системой YooMoney QuickPay для обработки платежей.

---

## Типы подписок

### 1. FREE (Бесплатная)
- **Цена**: Бесплатно (только при регистрации)
- **Кредиты**: 100 кредитов в месяц
- **Генерации фото**: 5 генераций в месяц
- **Максимальная длина сообщения**: 100 символов
- **Особенности**: 
  - Доступна только при регистрации
  - Не может быть активирована повторно вручную
  - Остатки кредитов и фото суммируются при смене подписки

### 2. STANDARD (Стандартная)
- **Цена**: 699₽ в месяц
- **Кредиты**: 1500 кредитов в месяц
- **Генерации фото**: Без лимита (оплачивается 10 кредитами с баланса за каждое фото)
- **Максимальная длина сообщения**: 200 символов
- **Особенности**:
  - Кредиты переводятся на баланс пользователя (`user.coins`)
  - При продлении кредиты суммируются с текущими остатками
  - При смене подписки остатки сохраняются и переводятся на баланс
  - Генерация фото оплачивается только кредитами с баланса (10 кредитов за фото)

### 3. PREMIUM (Премиум)
- **Цена**: 1499₽ в месяц
- **Кредиты**: 5000 кредитов в месяц
- **Генерации фото**: Без лимита (оплачивается 10 кредитами с баланса за каждое фото)
- **Максимальная длина сообщения**: 300 символов
- **Особенности**:
  - Кредиты переводятся на баланс пользователя (`user.coins`)
  - При продлении кредиты суммируются с текущими остатками
  - При смене подписки остатки сохраняются и переводятся на баланс
  - Генерация фото оплачивается только кредитами с баланса (10 кредитов за фото)

---

## Система кредитов

### Модель "Кошелек"

Система использует модель **"Кошелек"**: кредиты начисляются на баланс пользователя (`user.coins`) и **живут вечно**, пока не потратятся. Баланс пользователя **НЕ сбрасывается** через 30 дней.

### Расход кредитов

#### Отправка сообщения (5 кредитов)
- **Вариант 1** (если `use_credits=True`): Списывается с лимита подписки (`subscription.used_credits += 5`)
- **Вариант 2** (если `use_credits=False`): Списывается с баланса пользователя (`user.coins -= 5`)

#### Генерация фото (10 кредитов)
- **Всегда** списывается с баланса пользователя (`user.coins -= 10`)
- **Для STANDARD и PREMIUM**: только проверяется активность подписки, кредиты списываются с баланса
- **Для FREE**: дополнительно проверяется/списывается лимит подписки:
  - Сначала используется `subscription.used_photos` (5 фото в месяц)
  - Если лимит исчерпан, используется `subscription.used_credits` (10 кредитов)

### Управление балансом

Кредиты хранятся в двух местах:

1. **Баланс пользователя** (`Users.coins`) - **КОШЕЛЕК**
   - Начисляется при активации подписки: `user.coins += monthly_credits`
   - Начисляется при докупке (top-up): `user.coins += package.credits`
   - **НЕ сбрасывается** через 30 дней
   - Используется для генерации фото и (опционально) для сообщений
   - **Живет вечно** до полного расходования

2. **Счетчики подписки** (`UserSubscription.used_credits`, `UserSubscription.used_photos`) - **МЕСЯЧНЫЕ ЛИМИТЫ**
   - Отслеживают использование месячных лимитов подписки
   - **Сбрасываются** каждые 30 дней через `reset_monthly_limits()`
   - Используются для проверки разрешений и (опционально) для списания при сообщениях

**Важно**: 
- При активации подписки кредиты **переводятся на баланс** пользователя (`user.coins += monthly_credits`)
- Баланс `user.coins` **НЕ сбрасывается** - это постоянный кошелек пользователя
- Сбрасываются только счетчики `used_credits` и `used_photos` в подписке

---

## Система докупки кредитов (Credit Top-up)

Для пользователей с активной подпиской доступна возможность докупить кредиты разовыми пакетами.

### Пакеты кредитов

Конфигурация находится в `app/config/credit_packages.py`:

#### Small (Малый)
- **Кредиты**: 200
- **Цена**: 199₽
- **Цена за кредит**: ~1.0₽/кредит
- **ID**: `small`

#### Medium (Средний)
- **Кредиты**: 500
- **Цена**: 449₽
- **Цена за кредит**: ~0.9₽/кредит
- **ID**: `medium`

#### Large (Большой)
- **Кредиты**: 1000
- **Цена**: 899₽
- **Цена за кредит**: ~0.9₽/кредит
- **ID**: `large`

### Особенности Credit Top-up

1. **Суммирование с балансом**: Кредиты добавляются к текущему балансу пользователя
2. **Не влияет на подписку**: Дата окончания подписки (`subscription_end_date`) **НЕ меняется**
3. **Премиальное ценообразование**: Цена за кредит выше, чем в подписке (стимулирует продление)
4. **Доступность**: Только для пользователей с активной подпиской

### Логика работы

```python
# app/services/profit_activate.py
async def add_credits_topup(self, user_id: int, credits: int) -> Dict[str, Any]:
    """
    Добавляет кредиты пользователю при разовой покупке.
    Кредиты суммируются с текущим балансом, дата окончания подписки НЕ меняется.
    """
    user.coins += credits  # Просто добавляем к балансу
    # subscription_end_date остается без изменений
```

---

## Интеграция с YooMoney QuickPay

### Обработка платежей

Эндпоинт: `POST /api/v1/youmoney/quickpay/notify`

### Формат label для платежей

#### Подписка
```
plan:<standard|premium>;uid:<userId>
```

Пример: `plan:premium;uid:37`

#### Докупка кредитов (Top-up)
```
type:topup;package:<package_id>;uid:<userId>
```

Пример: `type:topup;package:small;uid:37`

### Верификация платежа

1. **Проверка SHA1 подписи**: Вычисляется от строки:
   ```
   notification_type&operation_id&amount&currency&datetime&sender&codepro&notification_secret&label
   ```

2. **Проверка идемпотентности**: 
   - Проверяется наличие `operation_id` в таблице `payment_transactions`
   - Если платеж уже обработан (`processed=True`), возвращается успешный ответ без повторной обработки
   - Это защищает от дубликатов при повторных запросах от YooMoney

3. **Проверка суммы**: 
   - Для подписок: минимум `min_standard` (699₽) или `min_premium` (1499₽)
   - Для top-up: минимум 95% от цены пакета (учитывает комиссии)

4. **Отклонение защищенных платежей**: `codepro=true` не принимается

### Обработка успешного платежа

#### Проверка дубликатов
```python
# app/youmoney/router.py
# Проверяем, не обрабатывали ли мы уже этот operation_id
existing_transaction = await db.execute(
    select(PaymentTransaction).where(
        PaymentTransaction.operation_id == data["operation_id"]
    )
)
transaction = existing_transaction.scalars().first()

if transaction and transaction.processed:
    # Платеж уже обработан - возвращаем успешный ответ (идемпотентность)
    return {"ok": True, "duplicate": True}
```

#### Подписка
```python
if payment_type == "subscription":
    sub = await service.activate_subscription(user_id, plan)
    # Помечаем транзакцию как обработанную
    transaction.processed = True
    transaction.processed_at = datetime.utcnow()
    await db.commit()
```

#### Top-up
```python
if payment_type == "topup" and package_id:
    package = get_credit_package(package_id)
    result = await service.add_credits_topup(user_id, package.credits)
    # Помечаем транзакцию как обработанную
    transaction.processed = True
    transaction.processed_at = datetime.utcnow()
    await db.commit()
```

---

## Логика работы подписок

### Активация новой подписки

1. Создается запись `UserSubscription`
2. Кредиты переводятся на баланс: `user.coins += monthly_credits`
3. Устанавливается срок действия: `expires_at = now + 30 дней`
4. Инвалидируется кэш подписки

### Продление подписки

Если пользователь продлевает **ту же** подписку:

1. **Дата окончания сдвигается**: `expires_at = old_expires_at + 30 дней`
2. **Кредиты суммируются**: `user.coins += monthly_credits` (новые кредиты добавляются к балансу)
3. **Лимиты обновляются**: `monthly_credits` увеличивается на новый лимит
4. **Остатки сохраняются**: Старые остатки остаются на балансе

### Смена подписки

Если пользователь меняет тип подписки (например, STANDARD → PREMIUM):

1. **Остатки сохраняются**: Старые остатки кредитов и фото сохраняются
2. **Кредиты суммируются и переводятся на баланс**: 
   ```python
   total_credits = monthly_credits + old_credits_remaining
   user.coins += total_credits
   ```
3. **Фото суммируются** (для FREE): `monthly_photos = new_monthly_photos + old_photos_remaining`
4. **Тип подписки обновляется**: `subscription_type = new_type`
5. **Новая дата окончания**: `expires_at = now + 30 дней`

### Автоматический сброс лимитов подписки

**ВАЖНО**: Сбрасываются **ТОЛЬКО счетчики подписки**, а **НЕ баланс пользователя**.

Что сбрасывается:
- `subscription.used_credits = 0` - счетчик использованных кредитов подписки
- `subscription.used_photos = 0` - счетчик использованных генераций фото
- `subscription.last_reset_at = now()` - обновляется дата последнего сброса
- `subscription.expires_at = now() + 30 дней` - продлевается подписка на месяц

Что **НЕ сбрасывается**:
- `user.coins` - баланс пользователя остается без изменений (кошелек)
- Кредиты, купленные через top-up, остаются на балансе
- Кредиты, начисленные при активации подписки, остаются на балансе

Лимиты сбрасываются автоматически при:
- Проверке статистики подписки
- Использовании кредитов/фото
- Проверке разрешений

Условие сброса: `last_reset_at` старше 30 дней или не установлен.

**Пример**: 
- Пользователь купил PREMIUM (5000 кредитов) → `user.coins = 5000`
- Потратил 100 кредитов → `user.coins = 4900`
- Через 30 дней сбрасываются только счетчики подписки → `user.coins` остается **4900** (не обнуляется!)

---

## API Эндпоинты

### Подписки

#### `GET /api/v1/subscription/stats/`
Получает статистику подписки текущего пользователя.

**Ответ**:
```json
{
  "subscription_type": "premium",
  "status": "active",
  "monthly_credits": 5000,
  "monthly_photos": 0,
  "used_credits": 150,
  "used_photos": 0,
  "credits_remaining": 4850,
  "photos_remaining": 0,
  "days_left": 25,
  "is_active": true,
  "expires_at": "2026-01-15T16:22:06.775435",
  "last_reset_at": "2025-12-15T16:22:06.775435"
}
```

#### `POST /api/v1/subscription/activate/`
Активирует подписку для пользователя.

**Тело запроса**:
```json
{
  "subscription_type": "premium"
}
```

**Ответ**:
```json
{
  "success": true,
  "message": "Подписка Premium успешно активирована! Вы получили 5000 кредитов. Генерация фото оплачивается кредитами (10 кредитов за фото).",
  "subscription": { ... }
}
```

#### `GET /api/v1/subscription/info/`
Получает полную информацию о подписке.

#### `GET /api/v1/subscription/check/message/`
Проверяет, может ли пользователь отправить сообщение.

#### `GET /api/v1/subscription/check/photo/`
Проверяет, может ли пользователь сгенерировать фото.

### Пакеты кредитов

#### `GET /api/v1/subscription/credit-packages/`
Получает список доступных пакетов для докупки кредитов.

**Ответ**:
```json
{
  "success": true,
  "packages": [
    {
      "id": "small",
      "name": "Small",
      "credits": 200,
      "price": 199.0,
      "price_per_credit": 0.995,
      "description": ""
    },
    {
      "id": "medium",
      "name": "Medium",
      "credits": 500,
      "price": 449.0,
      "price_per_credit": 0.898,
      "description": ""
    },
    {
      "id": "large",
      "name": "Large",
      "credits": 1000,
      "price": 899.0,
      "price_per_credit": 0.899,
      "description": ""
    }
  ]
}
```

---

## Кэширование

Система использует Redis для кэширования данных подписок:

### Ключи кэша

- `subscription:{user_id}` - данные подписки пользователя
- `subscription_stats:{user_id}` - статистика подписки
- `user:{email}` - данные пользователя (инвалидируется при top-up)

### TTL (Time To Live)

- Подписка: `TTL_SUBSCRIPTION` (по умолчанию)
- Статистика: `TTL_SUBSCRIPTION_STATS` (по умолчанию)

### Инвалидация кэша

Кэш инвалидируется при:
- Активации/продлении подписки
- Докупке кредитов (top-up)
- Использовании кредитов/фото
- Автоматическом сбросе лимитов

---

## Модели данных

### UserSubscription

```python
class UserSubscription:
    id: int
    user_id: int
    subscription_type: SubscriptionType  # FREE, STANDARD, PREMIUM
    status: SubscriptionStatus  # ACTIVE, INACTIVE
    monthly_credits: int
    monthly_photos: int  # 5 (FREE), 0 (STANDARD/PREMIUM - без лимита, оплачивается кредитами)
    max_message_length: int
    used_credits: int
    used_photos: int
    activated_at: datetime
    expires_at: datetime
    last_reset_at: datetime
```

### Users

```python
class Users:
    id: int
    email: str
    coins: int  # Баланс кредитов пользователя (кошелек, не сбрасывается)
    # ... другие поля
```

### PaymentTransaction

```python
class PaymentTransaction:
    id: int
    operation_id: str  # Уникальный ID транзакции YooMoney (для идемпотентности)
    payment_type: str  # "subscription" или "topup"
    user_id: int
    amount: str
    currency: str
    label: str
    package_id: str | None  # Для topup
    subscription_type: str | None  # Для subscription
    processed: bool  # Обработан ли платеж
    created_at: datetime
    processed_at: datetime | None
```

---

## Безопасность

### Валидация платежей

1. **SHA1 подпись**: Все платежи проверяются через SHA1 хеш
2. **Идемпотентность**: Проверка дубликатов через таблицу `payment_transactions` по `operation_id`
3. **Минимальные суммы**: Проверка соответствия суммы ожидаемой цене
4. **Защищенные платежи**: Отклонение платежей с `codepro=true`
5. **Проверка пользователя**: Валидация `user_id` из label

### Защита от злоупотреблений

1. **Генерация фото оплачивается кредитами**: 
   - Для STANDARD и PREMIUM: каждое фото стоит 10 кредитов с баланса (`user.coins`)
   - Если у пользователя нет кредитов - генерация невозможна
   - Это естественным образом ограничивает злоупотребления (нужно покупать кредиты)
2. **Идемпотентность платежей**: Предотвращение двойного начисления при повторных webhook от YooMoney

### Логирование

Все операции с подписками и кредитами логируются:
- Активация подписки
- Продление подписки
- Смена подписки
- Докупка кредитов
- Изменение баланса

---

## Файлы реализации

### Backend

- `app/services/subscription_service.py` - Основной сервис подписок
- `app/services/profit_activate.py` - Активация подписок и top-up
- `app/config/credit_packages.py` - Конфигурация пакетов кредитов
- `app/api/endpoints/subscription_endpoints.py` - API эндпоинты
- `app/youmoney/router.py` - Обработка платежей YooMoney (с идемпотентностью)
- `app/models/subscription.py` - Модели данных подписок
- `app/models/payment_transaction.py` - Модель транзакций для идемпотентности

### Frontend

- `frontend/src/components/ShopPage.tsx` - Страница магазина с подписками и пакетами
- `frontend/src/components/ShopModal.tsx` - Модальное окно подписок

---

## Примеры использования

### Активация подписки через API

```python
POST /api/v1/subscription/activate/
{
  "subscription_type": "premium"
}
```

### Покупка пакета кредитов

1. Пользователь выбирает пакет на фронтенде
2. Формируется URL YooMoney с label: `type:topup;package:small;uid:37`
3. После оплаты YooMoney отправляет webhook на `/api/v1/youmoney/quickpay/notify`
4. Система проверяет платеж и вызывает `add_credits_topup(user_id, 200)`
5. Кредиты добавляются на баланс пользователя

### Проверка возможности отправки сообщения

```python
GET /api/v1/subscription/check/message/
# Проверяет:
# 1. Есть ли активная подписка
# 2. Достаточно ли кредитов (5 кредитов)
# 3. Не превышена ли максимальная длина сообщения
```

---

## Важные замечания

1. **Модель "Кошелек"**: Кредиты хранятся в `user.coins` и **НЕ сгорают** через 30 дней
2. **Сброс только счетчиков**: Через 30 дней сбрасываются только `used_credits` и `used_photos`, баланс `user.coins` остается без изменений
3. **Остатки при смене**: При смене подписки остатки сохраняются и переводятся на баланс
4. **Продление vs Смена**: Продление сдвигает дату окончания, смена создает новую дату
5. **Top-up не продлевает**: Докупка кредитов НЕ влияет на дату окончания подписки
6. **Генерация фото без лимита**: Для STANDARD и PREMIUM генерация фото оплачивается только кредитами (10 кредитов за фото). Если кредитов нет - генерация невозможна
7. **Два пути для сообщений**: Сообщения могут списываться либо с лимита подписки, либо с баланса (зависит от параметра `use_credits`)
8. **Фото всегда с баланса**: Генерация фото всегда списывает 10 кредитов с `user.coins`, дополнительно проверяется лимит подписки
9. **Идемпотентность платежей**: Все платежи проверяются на дубликаты через `operation_id` в таблице `payment_transactions`

---

## Критические исправления (2025)

### 1. Генерация фото оплачивается кредитами
**Проблема**: Изначально для STANDARD и PREMIUM было установлено `monthly_photos = 0` (без ограничений), что создавало экономическую уязвимость - злонамеренный пользователь мог сгенерировать тысячи фото за ночь.

**Решение**: 
- Генерация фото для STANDARD и PREMIUM оплачивается только кредитами с баланса (10 кредитов за фото)
- Если у пользователя нет кредитов - генерация невозможна
- Это естественным образом ограничивает злоупотребления (нужно покупать кредиты)

### 2. Идемпотентность платежей
**Проблема**: YooMoney может отправить один и тот же webhook дважды из-за сетевых сбоев, что приводит к двойному начислению кредитов.

**Решение**: 
- Создана таблица `payment_transactions` для хранения `operation_id`
- Перед обработкой платежа проверяется наличие `operation_id` в БД
- Если платеж уже обработан (`processed=True`), возвращается успешный ответ без повторной обработки

### 3. Модель "Кошелек"
**Проблема**: В документации было противоречие между "сбросом лимитов" и "кошельком" - не было ясно, сбрасывается ли баланс пользователя.

**Решение**: 
- Уточнено, что `user.coins` - это кошелек, который **НЕ сбрасывается**
- Сбрасываются только счетчики `used_credits` и `used_photos` в подписке
- Документация обновлена с четким разделением понятий

---

## Будущие улучшения

- [ ] Добавление тарифа PRO
- [ ] Промокоды и скидки
- [ ] Реферальная программа
- [ ] История платежей
- [ ] Автоматическое продление подписки
- [ ] Уведомления об истечении подписки
- [ ] Мониторинг подозрительной активности (защита от ботов)
