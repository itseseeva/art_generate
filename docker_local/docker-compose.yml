services:
  # Redis - очередь задач
  redis:
    image: redis:7-alpine
    container_name: art_generation_redis_local
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data_local:/data
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --save 300 100
      --save 900 1
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 300
      --maxclients 10000
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      app_network:
        aliases:
          - redis
          - art_generation_redis_local
    sysctls:
      - net.core.somaxconn=1024

  # Celery Worker - обработка задач (подключается к Redis по имени сервиса "redis")
  celery_worker:
    build:
      context: ..
      dockerfile: docker_local/Dockerfile.celery
    container_name: art_generation_celery_local
    restart: unless-stopped
    command: >
      celery -A app.celery_app worker
      --loglevel=info
      --concurrency=8
      --queues=high_priority,normal_priority,low_priority
      --max-tasks-per-child=50
      --time-limit=600
      --soft-time-limit=540
    env_file:
      - ../.env
    environment:
      # Явно задаём хост Redis (имя сервиса) — не переопределять из .env
      - REDIS_URL=redis://redis:6379/0
      - REDIS_LOCAL=redis://redis:6379/0
      - IS_DOCKER=true
      - APP_SD_API_URL=http://host.docker.internal:7860
      - DATABASE_URL=${DATABASE_URL:-sqlite+aiosqlite:///./app.db}
      - APP_DATABASE_URL=${APP_DATABASE_URL:-sqlite+aiosqlite:///./app.db}
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Монтируем код для live reload (read-only)
      - ../app:/app/app:ro
      - ../app.db:/app/app.db
      - ../logs:/app/logs
      - ../outputs:/app/outputs
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.celery_app inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Beat - периодические задачи
  celery_beat:
    build:
      context: ..
      dockerfile: docker_local/Dockerfile.celery
    container_name: art_generation_celery_beat_local
    restart: unless-stopped
    command: >
      celery -A app.celery_app beat
      --loglevel=info
    env_file:
      - ../.env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - REDIS_LOCAL=redis://redis:6379/0
      - IS_DOCKER=true
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app_network
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  redis_data_local:
    driver: local

networks:
  app_network:
    driver: bridge
