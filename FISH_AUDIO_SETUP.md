# Fish Audio TTS - Руководство по настройке

## Установка зависимостей

После обновления кода необходимо установить новую зависимость:

```bash
pip install fish-audio-sdk>=1.0.0
```

Или установить все зависимости из requirements.txt:

```bash
pip install -r requirements.txt
```

## Настройка API ключа

### 1. Получение API ключа

1. Зарегистрируйтесь на [fish.audio](https://fish.audio/)
2. Перейдите в раздел API / Developer Settings
3. Создайте новый API ключ
4. Скопируйте ключ

### 2. Добавление в .env

Откройте файл `.env` в корне проекта и добавьте:

```env
FISH_AUDIO_API_KEY=your_api_key_here
```

## Как это работает

### Архитектура

1. **Загрузка образцов голосов**
   - При первом использовании голоса из `app/default_character_voices/`
   - Файл загружается в Fish Audio как "reference"
   - Получается `reference_id`, который кэшируется в памяти

2. **Генерация TTS**
   - Используется сохраненный `reference_id`
   - Текст преобразуется в речь с характеристиками образца голоса
   - Результат сохраняется локально в `app/voices/`

3. **Кэширование**
   - Превью голосов кэшируются на диске (по MD5 от voice_id + text)
   - Reference ID кэшируются в памяти для быстрого доступа

### Основные функции

#### `generate_tts_audio(text: str, voice_url: str)`
Генерирует озвучку для произвольного текста с использованием указанного голоса.

**Параметры:**
- `text` - текст для озвучки
- `voice_url` - URL голоса (формат: `/default_character_voices/filename.mp3`)

**Возвращает:**
- Относительный путь к аудио файлу или `None` при ошибке

#### `generate_voice_preview(voice_id: str, text: Optional[str])`
Генерирует превью голоса со стандартной фразой приветствия.

**Параметры:**
- `voice_id` - имя файла голоса из `default_character_voices`
- `text` - опциональный текст (по умолчанию используется стандартная фраза)

**Возвращает:**
- Относительный путь к аудио файлу или `None` при ошибке

## API Endpoints

### POST /api/v1/chat/generate_voice
Генерация озвучки для сообщения персонажа.

**Запрос:**
```json
{
  "text": "Привет! Как дела?",
  "voice_url": "/default_character_voices/voice_preview_aitana_warm_friendly_and_expressive.mp3"
}
```

**Ответ:**
```json
{
  "status": "success",
  "audio_url": "/voices/abc123-def456.mp3"
}
```

### POST /api/v1/chat/preview-voice
Генерация превью голоса со стандартной фразой.

**Запрос:**
```json
{
  "voice_id": "voice_preview_aitana_warm_friendly_and_expressive.mp3",
  "text": null
}
```

**Ответ:**
```json
{
  "status": "success",
  "audio_url": "/voices/preview_hash123.mp3"
}
```

## Устранение неполадок

### Ошибка: "FISH_AUDIO_API_KEY не установлен"

**Решение:**
- Убедитесь, что API ключ добавлен в `.env` файл
- Перезапустите сервер после добавления ключа

### Ошибка при загрузке reference

**Возможные причины:**
- Неверный API ключ
- Файл голоса не найден в `default_character_voices/`
- Проблемы с сетью / доступом к Fish Audio API

**Решение:**
- Проверьте логи сервера для деталей
- Убедитесь, что файлы голосов существуют
- Проверьте доступность Fish Audio API

### Ошибка: модуль fishaudio не найден

**Решение:**
```bash
pip install fish-audio-sdk
```

## Примечания

### Кэширование

- **Reference ID** кэшируются в памяти (сбрасываются при перезапуске сервера)
- **Превью аудио** кэшируются на диске в `app/voices/` (постоянное хранение)

Для очистки кэша превью:
```bash
rm -rf app/voices/preview_*.mp3
```

### Производительность

- Первая генерация с новым голосом занимает больше времени (загрузка reference)
- Последующие генерации быстрее (используется кэшированный reference_id)
- Превью генерируются один раз и кэшируются навсегда

### Лимиты API

Fish Audio имеет лимиты на количество запросов. Проверьте вашу квоту на [fish.audio](https://fish.audio/).

## Что изменилось

### Удалено
- ❌ fal.ai интеграция
- ❌ fal-client зависимость
- ❌ Настройки FAL_API_KEY, DIA_TTS_MODEL, PUBLIC_BASE_URL

### Добавлено
- ✅ Fish Audio SDK интеграция
- ✅ fish-audio-sdk зависимость
- ✅ Настройка FISH_AUDIO_API_KEY
- ✅ Автоматическая загрузка и кэширование голосов
- ✅ Улучшенная обработка ошибок с traceback

## Дальнейшие улучшения

Возможные улучшения в будущем:

1. **Персистентное хранение reference_id**
   - Сохранение в Redis или БД для избежания повторной загрузки

2. **Пакетная загрузка голосов**
   - Предварительная загрузка всех голосов при старте сервера

3. **Настройка параметров TTS**
   - Скорость речи (speed)
   - Громкость (volume)
   - Эмоции (emotion)

4. **Мониторинг использования**
   - Статистика использования API
   - Отслеживание квоты
